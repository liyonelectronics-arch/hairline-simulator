<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SMP 极致密度模拟器 v3.2</title>
    <style>
        :root { --primary: #1677ff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #111; color: #fff; padding: 10px; }
        .panel { background: #222; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; }
        h3 { margin-bottom: 10px; font-size: 14px; color: #888; text-transform: uppercase; }
        
        /* 增加画布容器阴影，方便手机区分边界 */
        .canvas-container { position: relative; width: 100%; max-width: 600px; margin: 0 auto; background: #000; border-radius: 8px; overflow: hidden; touch-action: none; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        canvas { width: 100%; display: block; }
        
        /* 增大定位点触点，方便手机拖拽 */
        .anchor { position: absolute; width: 34px; height: 34px; background: rgba(255, 0, 0, 0.5); border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); cursor: move; z-index: 10; display: none; }
        .anchor::after { content: attr(data-label); position: absolute; top: -24px; left: 50%; transform: translateX(-50%); font-size: 11px; background: #f00; color: #fff; padding: 2px 6px; border-radius: 4px; white-space: nowrap; font-weight: bold; }

        .ctrl-group { margin-bottom: 15px; }
        .label-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; color: #bbb; }
        .label-row span:last-child { color: var(--primary); font-weight: bold; font-family: monospace; }
        input[type=range] { width: 100%; accent-color: var(--primary); height: 20px; cursor: pointer; }
        
        .btn-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        button { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-main { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(22,119,255,0.3); }
        .btn-sub { background: #333; color: #eee; border: 1px solid #444; }
        .btn-save { background: #218838; color: white; grid-column: span 2; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="panel">
        <input type="file" id="uploadInput" accept="image/*" style="display: none;">
        <div class="btn-box">
            <button class="btn-sub" onclick="document.getElementById('uploadInput').click()">1. 上传照片</button>
            <button class="btn-main" onclick="generateSMP()">2. 生成极致纹发</button>
            <button class="btn-save" onclick="saveResult()">下载成品图</button>
        </div>
        <p style="font-size: 11px; color: #666; text-align: center;">操作技巧：拖动大红点锁定头型，点图可切换红点显示</p>
    </div>

    <div class="canvas-container" id="container" onclick="showAnchors()">
        <canvas id="mainCanvas"></canvas>
        <div id="pTop" class="anchor" data-label="头顶边缘" style="top: 5%; left: 50%;"></div>
        <div id="pBottom" class="anchor" data-label="发际线边缘" style="top: 30%; left: 50%;"></div>
        <div id="pLeft" class="anchor" data-label="左鬓角" style="top: 20%; left: 20%;"></div>
        <div id="pRight" class="anchor" data-label="右鬓角" style="top: 20%; left: 80%;"></div>
    </div>

    <div class="panel">
        <h3>参数调优（当前已设为推荐值）</h3>
        <div class="ctrl-group">
            <div class="label-row"><span>点阵密度 (Extreme Density)</span><span id="densityVal">120%</span></div>
            <input type="range" id="densitySlider" min="50" max="300" value="120">
        </div>
        <div class="ctrl-group">
            <div class="label-row"><span>色值深浅 (Darkness)</span><span id="opacityVal">90%</span></div>
            <input type="range" id="opacitySlider" min="30" max="100" value="90">
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const container = document.getElementById('container');
        const anchors = document.querySelectorAll('.anchor');
        let rawImg = null;

        document.getElementById('uploadInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                rawImg = new Image();
                rawImg.onload = function() {
                    canvas.width = rawImg.width;
                    canvas.height = rawImg.height;
                    renderGuide();
                };
                rawImg.src = event.target.result;
            };
            reader.readAsDataURL(file);
        };

        let activeAnchor = null;
        const startDrag = (e) => { 
            if (e.target.classList.contains('anchor')) {
                activeAnchor = e.target; 
                e.preventDefault();
                e.stopPropagation(); 
            }
        };
        container.addEventListener('mousedown', startDrag);
        container.addEventListener('touchstart', startDrag, {passive: false});
        
        const drag = (e) => {
            if (!activeAnchor) return;
            e.preventDefault();
            const rect = container.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            activeAnchor.style.left = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100)) + '%';
            activeAnchor.style.top = Math.max(0, Math.min(100, ((clientY - rect.top) / rect.height) * 100)) + '%';
            renderGuide();
        };
        window.addEventListener('mousemove', drag);
        window.addEventListener('touchmove', drag, {passive: false});
        window.addEventListener('mouseup', () => activeAnchor = null);
        window.addEventListener('touchend', () => activeAnchor = null);

        function showAnchors() {
            if (rawImg) anchors.forEach(a => a.style.display = 'block');
        }

        // 实时渲染引导层，让用户看到“模拟范围”
        function renderGuide() {
            if(!rawImg) return;
            ctx.drawImage(rawImg, 0, 0);
            anchors.forEach(a => a.style.display = 'block');
            
            const T = getPixelPos('pTop'), B = getPixelPos('pBottom'), L = getPixelPos('pLeft'), R = getPixelPos('pRight');
            ctx.save();
            ctx.strokeStyle = "rgba(0, 255, 0, 0.3)";
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            const rx = Math.abs(R.x - L.x) / 2;
            const ry = Math.abs(B.y - T.y);
            ctx.ellipse((L.x + R.x)/2, T.y + ry, rx, ry, 0, 0, Math.PI * 2);
            ctx.stroke();
            ctx.fillStyle = "rgba(0, 255, 0, 0.05)";
            ctx.fill();
            ctx.restore();
        }

        function getPixelPos(id) {
            const el = document.getElementById(id);
            return {
                x: (parseFloat(el.style.left) / 100) * canvas.width,
                y: (parseFloat(el.style.top) / 100) * canvas.height
            };
        }

        function generateSMP() {
            if (!rawImg) return alert("请先上传照片");
            anchors.forEach(a => a.style.display = 'none');

            const density = document.getElementById('densitySlider').value / 100;
            const opacity = document.getElementById('opacitySlider').value / 100;
            const T = getPixelPos('pTop'), B = getPixelPos('pBottom'), L = getPixelPos('pLeft'), R = getPixelPos('pRight');

            ctx.drawImage(rawImg, 0, 0);

            const centerX = (L.x + R.x) / 2;
            const radiusX = Math.abs(R.x - L.x) / 2;
            const radiusY = Math.abs(B.y - T.y);

            ctx.save();
            ctx.beginPath();
            ctx.ellipse(centerX, T.y + radiusY, radiusX, radiusY, 0, 0, Math.PI * 2);
            ctx.clip();

            // 极致点阵算法：缩小编距，增加多重覆盖
            const dotSize = Math.max(0.4, canvas.width / 1100);
            const step = 3.2 / (density * 1.8); 

            for (let x = L.x - 50; x < R.x + 50; x += step) {
                for (let y = T.y - 100; y < B.y + 50; y += step) {
                    const curve = Math.cos((x - centerX) / (radiusX * 0.82)) * (canvas.height * 0.045);
                    const currentLine = B.y + curve;

                    if (y < currentLine) {
                        const distFromEdge = currentLine - y;
                        const feather = Math.min(1, distFromEdge / (canvas.height * 0.1));
                        
                        // 逻辑修改：更强的起始覆盖率
                        if (Math.random() > (1 - feather * density * 1.2)) {
                            const finalAlpha = opacity * feather * (Math.random() * 0.3 + 0.7);
                            ctx.fillStyle = `rgba(15, 15, 18, ${finalAlpha})`; // 使用更接近发色的黑青色
                            ctx.beginPath();
                            // 极细微的抖动，增加真实肉感
                            ctx.arc(x + (Math.random()-0.5)*1.5, y + (Math.random()-0.5)*1.5, dotSize, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }
            }
            ctx.restore();
        }

        function saveResult() {
            if (!rawImg) return;
            const link = document.createElement('a');
            link.download = 'SMP_Ultra_Density.png';
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

        document.querySelectorAll('input').forEach(i => {
            i.oninput = function() {
                document.getElementById(this.id.replace('Slider', 'Val')).innerText = this.value + '%';
            }
        });
    </script>
</body>
</html>