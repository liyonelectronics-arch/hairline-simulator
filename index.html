<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SMP 纹发专业模拟</title>
    <style>
        :root { --primary: #1677ff; --guide: #00e5ff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #1a1a1a; color: #fff; padding: 10px; }
        .panel { background: #262626; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; }
        h3 { margin-bottom: 10px; font-size: 14px; color: #aaa; text-align: center; }
        
        /* 关键：确保没照片时也有高度，能看到边框 */
        .canvas-container { 
            position: relative; 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto; 
            background: #000; 
            border-radius: 8px; 
            overflow: hidden; 
            touch-action: none; 
            border: 1px solid #444; 
            min-height: 70vh; /* 使用屏幕高度的70%，确保相框显眼 */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        canvas { width: 100%; display: block; z-index: 1; }
        
        /* 拍照引导框 - 初始状态必须可见 */
        #photoGuide {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 65%; 
            height: 60%; 
            border: 2px dashed var(--guide); 
            border-radius: 50%; /* 调成你要求的更圆的形状 */
            pointer-events: none; 
            z-index: 100; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.2);
        }
        #photoGuide span { 
            color: var(--guide); 
            font-size: 13px; 
            background: rgba(0,0,0,0.6); 
            padding: 6px 15px; 
            border-radius: 20px; 
            border: 1px solid var(--guide);
            text-align: center;
            white-space: nowrap;
        }

        .anchor { position: absolute; width: 34px; height: 34px; background: rgba(255, 0, 0, 0.6); border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); cursor: move; z-index: 999; display: none; }
        
        .btn-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 15px; }
        .btn-main { background: var(--primary); color: white; }
        .btn-sub { background: #444; color: #eee; }
        .btn-save { background: #218838; color: white; grid-column: span 2; margin-top: 5px; }
        
        input[type=range] { width: 100%; accent-color: var(--primary); height: 30px; }
        .label-row { display: flex; justify-content: space-between; font-size: 13px; margin-top: 10px; color: #bbb; }
        b { color: var(--primary); }
    </style>
</head>
<body>

    <div class="panel">
        <h3>SMP 纹发模拟系统</h3>
        <input type="file" id="uploadInput" accept="image/*" style="display: none;">
        <div class="btn-box">
            <button class="btn-sub" id="uploadBtn">选取照片 / 拍照</button>
            <button class="btn-main" onclick="generateSMP()">生成模拟</button>
            <button class="btn-save" onclick="saveResult()">保存方案图</button>
        </div>
    </div>

    <div class="canvas-container" id="container">
        <div id="photoGuide">
            <span>请将头部放入圆框内</span>
        </div>
        
        <canvas id="mainCanvas"></canvas>
        
        <div id="pTop" class="anchor" style="top: 20%; left: 50%;"></div>
        <div id="pBottom" class="anchor" style="top: 45%; left: 50%;"></div>
        <div id="pLeft" class="anchor" style="top: 30%; left: 25%;"></div>
        <div id="pRight" class="anchor" style="top: 30%; left: 75%;"></div>
    </div>

    <div class="panel">
        <div class="label-row"><span>点阵密度</span><b id="densityVal">120%</b></div>
        <input type="range" id="densitySlider" min="50" max="300" value="120">
        <div class="label-row"><span>色值深浅</span><b id="opacityVal">90%</b></div>
        <input type="range" id="opacitySlider" min="30" max="100" value="90">
    </div>

<script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const container = document.getElementById('container');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadInput = document.getElementById('uploadInput');
        const guide = document.getElementById('photoGuide');
        const anchors = document.querySelectorAll('.anchor');
        let rawImg = null;
        let activeAnchor = null;

        // 统一上传触发
        uploadBtn.onclick = () => { uploadInput.value = ''; uploadInput.click(); };

        uploadInput.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    rawImg = img;
                    guide.style.display = 'none';
                    
                    // 1. 标准化画布内部像素逻辑
                    const aspect = rawImg.height / rawImg.width;
                    canvas.width = 800;
                    canvas.height = 800 * aspect;
                    
                    // 2. 关键修复：强制让外层黑框的高度等于照片高度，消除坐标偏差
                    container.style.height = container.offsetWidth * aspect + 'px';
                    
                    initAnchors();
                    renderGuide();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        };

        function initAnchors() {
            const defaults = [
                {id:'pTop', t:10, l:50}, {id:'pBottom', t:35, l:50},
                {id:'pLeft', t:25, l:25}, {id:'pRight', t:25, l:75}
            ];
            defaults.forEach(d => {
                const el = document.getElementById(d.id);
                el.style.top = d.t + '%';
                el.style.left = d.l + '%';
                el.style.display = 'block';
            });
        }

        // 精准捕捉手指位置并锁定在照片内
        const getTouchPos = (e) => {
            const rect = container.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            let xPer = (touch.clientX - rect.left) / rect.width;
            let yPer = (touch.clientY - rect.top) / rect.height;
            return {
                x: Math.max(0, Math.min(1, xPer)) * 100,
                y: Math.max(0, Math.min(1, yPer)) * 100
            };
        };

        const handleStart = (e) => {
            if (e.target.classList.contains('anchor')) {
                activeAnchor = e.target;
                if (e.cancelable) e.preventDefault();
            }
        };

        const handleMove = (e) => {
            if (!activeAnchor) return;
            const pos = getTouchPos(e);
            activeAnchor.style.left = pos.x + '%';
            activeAnchor.style.top = pos.y + '%';
            renderGuide(); // 拖动时实时显示蓝色阴影，方便生手对位
            if (e.cancelable) e.preventDefault();
        };

        container.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', () => activeAnchor = null);
        container.addEventListener('touchstart', handleStart, {passive: false});
        window.addEventListener('touchmove', handleMove, {passive: false});
        window.addEventListener('touchend', () => activeAnchor = null);

        // 将屏幕上的百分比 1:1 映射到画布像素
        function getCanvasCoords(id) {
            const el = document.getElementById(id);
            const leftPer = parseFloat(el.style.left) / 100;
            const topPer = parseFloat(el.style.top) / 100;
            return {
                x: leftPer * canvas.width,
                y: topPer * canvas.height
            };
        }

        function renderGuide() {
            if(!rawImg) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(rawImg, 0, 0, canvas.width, canvas.height);
            
            const T = getCanvasCoords('pTop'), 
                  B = getCanvasCoords('pBottom'), 
                  L = getCanvasCoords('pLeft'), 
                  R = getCanvasCoords('pRight');
            
            ctx.save();
            ctx.beginPath();
            // 以 L 点和 R 点为左右边界，T 点为顶部
            ctx.moveTo(L.x, T.y); 
            ctx.lineTo(R.x, T.y);
            ctx.lineTo(R.x, R.y);
            // 贝塞尔曲线：用 B 点作为底部弧度的控制参考
            ctx.quadraticCurveTo((L.x + R.x)/2, B.y, L.x, L.y);
            ctx.closePath();
            
            ctx.strokeStyle = "rgba(0, 229, 255, 0.8)";
            ctx.lineWidth = 3;
            ctx.setLineDash([8, 4]);
            ctx.stroke();
            
            // 填充一层半透明蓝色，直观告诉用户这里是纹发区
            ctx.fillStyle = "rgba(0, 229, 255, 0.15)";
            ctx.fill();
            ctx.restore();
        }

        function generateSMP() {
            if (!rawImg) return;
            anchors.forEach(a => a.style.display = 'none');
            
            const density = document.getElementById('densitySlider').value / 100;
            const opacity = document.getElementById('opacitySlider').value / 100;
            
            const T = getCanvasCoords('pTop'), 
                  B = getCanvasCoords('pBottom'), 
                  L = getCanvasCoords('pLeft'), 
                  R = getCanvasCoords('pRight');
            
            ctx.drawImage(rawImg, 0, 0, canvas.width, canvas.height);
            
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(L.x, T.y);
            ctx.lineTo(R.x, T.y);
            ctx.lineTo(R.x, R.y);
            ctx.quadraticCurveTo((L.x + R.x)/2, B.y, L.x, L.y);
            ctx.closePath();
            ctx.clip(); // 这里的裁剪区域和上面的蓝色预览框完全同步

            const dotSize = Math.max(0.4, canvas.width / 1100);
            const step = 3.6 / (density * 1.8); 
            
            for (let x = L.x - 50; x < R.x + 50; x += step) {
                for (let y = T.y - 100; y < B.y + 100; y += step) {
                    const ratio = (x - L.x) / (R.x - L.x);
                    // 模拟自然发际线弧度曲线
                    const curveY = L.y + (R.y - L.y) * ratio + Math.sin(ratio * Math.PI) * (B.y - (L.y + R.y)/2) * 2;
                    
                    if (y < curveY) {
                        const dist = Math.max(0, curveY - y);
                        const feather = Math.min(1, dist / (canvas.height * 0.08));
                        if (Math.random() > (1 - feather * density * 1.2)) {
                            ctx.fillStyle = `rgba(15, 15, 18, ${opacity * feather * (Math.random() * 0.3 + 0.7)})`; 
                            ctx.beginPath();
                            ctx.arc(x + (Math.random()-0.5)*1.5, y + (Math.random()-0.5)*1.5, dotSize, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }
            }
            ctx.restore();
        }

        function saveResult() {
            if (!rawImg) return;
            const link = document.createElement('a');
            link.download = 'SMP_Result.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        document.querySelectorAll('input').forEach(i => {
            i.oninput = function() { 
                document.getElementById(this.id.replace('Slider', 'Val')).innerText = this.value + '%'; 
            }
        });
    </script>
</body>
</html>